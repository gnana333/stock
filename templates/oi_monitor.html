<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OI Monitor - Total OI & OI Change Alerts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 12px 25px;
            font-size: 15px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-home {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-alerts {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-load {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .status-value.live {
            color: #11998e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f5576c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tables-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-table-wrapper {
            margin-top: 30px;
        }
        
        #comparisonTable thead th {
            color: white;
        }
        
        .table-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .table-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            white-space: nowrap;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.85em;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr.alert-row {
            background: #fff3cd;
        }
        
        .alert-badge {
            display: inline-block;
            padding: 3px 6px;
            background: #ff6b6b;
            color: white;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            margin-right: 3px;
        }
        
        .alert-badge.call {
            background: #ff6b6b;
        }
        
        .alert-badge.put {
            background: #ee5a6f;
        }
        
        .change-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .change-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .alerts-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .alerts-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .alert-item {
            background: white;
            padding: 15px;
            border-left: 4px solid #ff6b6b;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-time {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .alert-message {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .alert-details {
            font-size: 0.9em;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä OI Monitor</h1>
        <p class="subtitle">Total OI & OI Change Monitoring with Alerts</p>
        
        <div class="controls">
            <button onclick="window.location.href='/'" class="btn-home">üè† Volume Monitor</button>
            <button id="startBtn" onclick="startMonitoring()" class="btn-start">‚ñ∂Ô∏è Start Live Monitoring</button>
            <button id="stopBtn" onclick="stopMonitoring()" class="btn-stop" style="display: none;">‚è∏Ô∏è Stop Monitoring</button>
            <button id="storeEodBtn" onclick="storeLiveEodOi()" class="btn-alerts" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üíæ Store Live EOD OI (3:30PM)</button>
            <button onclick="window.location.href='/oi-alerts'" class="btn-alerts">üö® View All OI Alerts</button>
            <button onclick="window.location.href='/options'" class="btn-alerts">‚ö° Options Chain</button>
            <button onclick="window.location.href='/historical'" class="btn-alerts">üìÖ Historical Data</button>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Total Stocks</div>
                <div class="status-value" id="totalStocks">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Alerts (This Cycle)</div>
                <div class="status-value" id="alertCount">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Status</div>
                <div class="status-value" id="monitorStatus">Idle</div>
            </div>
            <div class="status-item">
                <div class="status-label">Last Update</div>
                <div class="status-value" id="lastUpdate">-</div>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading data... Please wait</p>
        </div>
        
        <div class="tables-wrapper">
            <div class="table-section">
                <div class="table-title">üìà Total OI - Near ATM Strikes Only (Spot ¬±10)</div>
                <div class="table-container">
                    <table id="oiTable">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Prev Call OI</th>
                                <th>Live Call OI</th>
                                <th>Prev Put OI</th>
                                <th>Live Put OI</th>
                                <th>Alerts</th>
                            </tr>
                        </thead>
                        <tbody id="oiTableBody">
                            <tr>
                                <td colspan="6" class="no-data">Load data from Volume Monitor first, then start monitoring</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="table-section">
                <div class="table-title">üìä Total Change in OI (vs Previous Day) - Near ATM Strikes Only (Spot ¬±10)</div>
                <div class="table-container">
                    <table id="oiChangeTable">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Prev CE OI Change</th>
                                <th>Live CE OI Change</th>
                                <th>Prev PE OI Change</th>
                                <th>Live PE OI Change</th>
                                <th>Alerts</th>
                            </tr>
                        </thead>
                        <tbody id="oiChangeTableBody">
                            <tr>
                                <td colspan="6" class="no-data">Load data from Volume Monitor first, then start monitoring</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- New Comparison Table Section -->
        <div class="comparison-table-wrapper" style="margin-top: 30px;">
            <div class="table-section">
                <div class="table-title">üìä Comparison: Difference vs Change in OI</div>
                <div class="table-container">
                    <table id="comparisonTable">
                        <thead>
                            <tr>
                                <th rowspan="2">Stock</th>
                                <th colspan="5" style="text-align: center; background: #ff6b6b;">CALLS (CE)</th>
                                <th colspan="5" style="text-align: center; background: #ee5a6f;">PUTS (PE)</th>
                            </tr>
                            <tr>
                                <!-- CALLS columns -->
                                <th style="background: #ff6b6b;">Prev Day Total OI</th>
                                <th style="background: #ff6b6b;">Live Total OI</th>
                                <th style="background: #ff6b6b;">Chng in OI</th>
                                <th style="background: #ff6b6b;">Difference</th>
                                <th style="background: #ff6b6b;">Alerts</th>
                                <!-- PUTS columns -->
                                <th style="background: #ee5a6f;">Prev Day Total OI</th>
                                <th style="background: #ee5a6f;">Live Total OI</th>
                                <th style="background: #ee5a6f;">Chng in OI</th>
                                <th style="background: #ee5a6f;">Difference</th>
                                <th style="background: #ee5a6f;">Alerts</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                            <tr>
                                <td colspan="11" class="no-data">Load data from Volume Monitor first, then start monitoring</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="alerts-section" id="alertsSection" style="display: none;">
            <div class="alerts-header">üö® Alerts (This Monitoring Cycle)</div>
            <div id="alertsList"></div>
        </div>
    </div>
    
    <script>
        // Global state - monitoring is OFF by default
        let monitoringInterval = null;
        let isMonitoring = false; // Monitoring starts ONLY when user clicks "Start"
        let currentCycleAlerts = [];
        let currentRequest = null; // Track current fetch request
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function updateStatus(status, isLive = false) {
            const statusEl = document.getElementById('monitorStatus');
            statusEl.textContent = status;
            if (isLive) {
                statusEl.classList.add('live');
            } else {
                statusEl.classList.remove('live');
            }
        }
        
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }
        
        async function loadTableData() {
            // Don't start new request if monitoring is stopped
            if (!isMonitoring) {
                console.log('Monitoring stopped, skipping request');
                return;
            }
            
            try {
                showLoading(true);
                updateStatus('Fetching data...', true);
                
                const startTime = Date.now();
                currentRequest = fetch('/api/get-oi-table-data');
                const response = await currentRequest;
                const data = await response.json();
                
                currentRequest = null;
                const fetchTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`Data fetched in ${fetchTime} seconds`);
                
                showLoading(false);
                
                if (data.success) {
                    const oiTableBody = document.getElementById('oiTableBody');
                    const oiChangeTableBody = document.getElementById('oiChangeTableBody');
                    const comparisonTableBody = document.getElementById('comparisonTableBody');
                    oiTableBody.innerHTML = '';
                    oiChangeTableBody.innerHTML = '';
                    comparisonTableBody.innerHTML = '';
                    
                    if (data.table_data.length === 0) {
                        oiTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
                        oiChangeTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
                        comparisonTableBody.innerHTML = '<tr><td colspan="11" class="no-data">No data available</td></tr>';
                        return;
                    }
                    
                    // Store new alerts from this cycle
                    if (data.new_alerts && data.new_alerts.length > 0) {
                        currentCycleAlerts = [...data.new_alerts, ...currentCycleAlerts];
                        displayAlerts();
                    }
                    
                    data.table_data.forEach(row => {
                        // OI Table Row
                        const oiTr = document.createElement('tr');
                        if (row.call_alert || row.put_alert) {
                            oiTr.classList.add('alert-row');
                        }
                        
                        let oiAlertBadges = '';
                        if (row.call_alert) {
                            oiAlertBadges += '<span class="alert-badge call">CALL</span>';
                        }
                        if (row.put_alert) {
                            oiAlertBadges += '<span class="alert-badge put">PUT</span>';
                        }
                        if (!row.call_alert && !row.put_alert) {
                            oiAlertBadges = '‚úÖ';
                        }
                        
                        oiTr.innerHTML = `
                            <td><strong>${row.symbol}</strong></td>
                            <td>${row.prev_call_oi_lots.toLocaleString()} lots</td>
                            <td>${row.live_call_oi_lots.toLocaleString()} lots</td>
                            <td>${row.prev_put_oi_lots.toLocaleString()} lots</td>
                            <td>${row.live_put_oi_lots.toLocaleString()} lots</td>
                            <td>${oiAlertBadges}</td>
                        `;
                        oiTableBody.appendChild(oiTr);
                        
                        // OI Change Table Row (Total Change in OI)
                        const oiChangeTr = document.createElement('tr');
                        if (row.call_oi_change_alert || row.put_oi_change_alert) {
                            oiChangeTr.classList.add('alert-row');
                        }
                        
                        let changeAlertBadges = '';
                        if (row.call_oi_change_alert) {
                            changeAlertBadges += '<span class="alert-badge call">CE</span>';
                        }
                        if (row.put_oi_change_alert) {
                            changeAlertBadges += '<span class="alert-badge put">PE</span>';
                        }
                        if (!row.call_oi_change_alert && !row.put_oi_change_alert) {
                            changeAlertBadges = '‚úÖ';
                        }
                        
                        const prevCallChangeClass = row.prev_call_oi_change > 0 ? 'change-positive' : 'change-negative';
                        const liveCallChangeClass = row.live_call_oi_change > 0 ? 'change-positive' : 'change-negative';
                        const prevPutChangeClass = row.prev_put_oi_change > 0 ? 'change-positive' : 'change-negative';
                        const livePutChangeClass = row.live_put_oi_change > 0 ? 'change-positive' : 'change-negative';
                        
                        oiChangeTr.innerHTML = `
                            <td><strong>${row.symbol}</strong></td>
                            <td class="${prevCallChangeClass}">${row.prev_call_oi_change > 0 ? '+' : ''}${row.prev_call_oi_change.toLocaleString()} lots</td>
                            <td class="${liveCallChangeClass}">${row.live_call_oi_change > 0 ? '+' : ''}${row.live_call_oi_change.toLocaleString()} lots</td>
                            <td class="${prevPutChangeClass}">${row.prev_put_oi_change > 0 ? '+' : ''}${row.prev_put_oi_change.toLocaleString()} lots</td>
                            <td class="${livePutChangeClass}">${row.live_put_oi_change > 0 ? '+' : ''}${row.live_put_oi_change.toLocaleString()} lots</td>
                            <td>${changeAlertBadges}</td>
                        `;
                        oiChangeTableBody.appendChild(oiChangeTr);
                        
                        // Combined Comparison Table Row (CALLS on left, PUTS on right)
                        const comparisonTr = document.createElement('tr');
                        if (row.call_diff_vs_chng_alert || row.put_diff_vs_chng_alert) {
                            comparisonTr.classList.add('alert-row');
                        }
                        
                        // CALLS side
                        let callComparisonAlertBadge = '';
                        if (row.call_diff_vs_chng_alert) {
                            callComparisonAlertBadge = '<span class="alert-badge call">ALERT</span>';
                        } else {
                            callComparisonAlertBadge = '‚úÖ';
                        }
                        
                        const callDifferenceClass = row.call_difference > 0 ? 'change-positive' : 'change-negative';
                        const callChngClass = row.live_call_oi_change > 0 ? 'change-positive' : 'change-negative';
                        
                        // PUTS side
                        let putComparisonAlertBadge = '';
                        if (row.put_diff_vs_chng_alert) {
                            putComparisonAlertBadge = '<span class="alert-badge put">ALERT</span>';
                        } else {
                            putComparisonAlertBadge = '‚úÖ';
                        }
                        
                        const putDifferenceClass = row.put_difference > 0 ? 'change-positive' : 'change-negative';
                        const putChngClass = row.live_put_oi_change > 0 ? 'change-positive' : 'change-negative';
                        
                        comparisonTr.innerHTML = `
                            <td><strong>${row.symbol}</strong></td>
                            <!-- CALLS columns -->
                            <td>${(row.prev_eod_call_oi_lots || 0).toLocaleString()} lots</td>
                            <td>${row.live_call_oi_lots.toLocaleString()} lots</td>
                            <td class="${callChngClass}">${row.live_call_oi_change > 0 ? '+' : ''}${row.live_call_oi_change.toLocaleString()} lots</td>
                            <td class="${callDifferenceClass}">${row.call_difference > 0 ? '+' : ''}${(row.call_difference || 0).toLocaleString()} lots</td>
                            <td>${callComparisonAlertBadge}</td>
                            <!-- PUTS columns -->
                            <td>${(row.prev_eod_put_oi_lots || 0).toLocaleString()} lots</td>
                            <td>${row.live_put_oi_lots.toLocaleString()} lots</td>
                            <td class="${putChngClass}">${row.live_put_oi_change > 0 ? '+' : ''}${row.live_put_oi_change.toLocaleString()} lots</td>
                            <td class="${putDifferenceClass}">${row.put_difference > 0 ? '+' : ''}${(row.put_difference || 0).toLocaleString()} lots</td>
                            <td>${putComparisonAlertBadge}</td>
                        `;
                        comparisonTableBody.appendChild(comparisonTr);
                    });
                    
                    document.getElementById('totalStocks').textContent = data.total_stocks;
                    updateLastUpdate();
                    
                    // Update status to show waiting
                    if (isMonitoring) {
                        updateStatus('Waiting for next cycle...', true);
                        
                        // Schedule next cycle after 5 seconds
                        monitoringInterval = setTimeout(() => {
                            loadTableData();
                        }, 5000); // 5 seconds wait before next cycle
                    }
                } else {
                    showLoading(false);
                    alert(`Error: ${data.error}`);
                    
                    // Retry after error
                    if (isMonitoring) {
                        monitoringInterval = setTimeout(() => {
                            loadTableData();
                        }, 5000);
                    }
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                showLoading(false);
                currentRequest = null;
                if (isMonitoring) {
                    updateStatus('Error - Retrying...', true);
                    
                    // Retry after error
                    monitoringInterval = setTimeout(() => {
                        loadTableData();
                    }, 5000);
                }
            }
        }
        
        function displayAlerts() {
            if (currentCycleAlerts.length === 0) {
                document.getElementById('alertsSection').style.display = 'none';
                document.getElementById('alertCount').textContent = '0';
                return;
            }
            
            const alertsSection = document.getElementById('alertsSection');
            const alertsList = document.getElementById('alertsList');
            
            alertsList.innerHTML = '';
            
            currentCycleAlerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item';
                
                const timestamp = alert.timestamp instanceof Date ? 
                    alert.timestamp.toLocaleTimeString() : 
                    alert.timestamp;
                
                let detailsHtml = '';
                
                // Check alert type and format details accordingly
                if (alert.alert_type.includes('TOTAL_OI_CHANGE')) {
                    // Total OI Change alerts (right table)
                    detailsHtml = `
                        <div class="alert-details">
                            Previous Total Change: ${alert.prev_total_change > 0 ? '+' : ''}${alert.prev_total_change.toLocaleString()} lots ‚Üí 
                            Live Total Change: ${alert.live_total_change > 0 ? '+' : ''}${alert.live_total_change.toLocaleString()} lots 
                            (Shift: ${alert.change_diff > 0 ? '+' : ''}${alert.change_diff.toLocaleString()} lots)
                        </div>
                    `;
                } else if (alert.alert_type.includes('DIFF_VS_CHNG_ALERT')) {
                    // Difference vs Change in OI alerts (comparison table)
                    detailsHtml = `
                        <div class="alert-details">
                            Difference: ${alert.difference > 0 ? '+' : ''}${alert.difference.toLocaleString()} lots | 
                            Chng in OI: ${alert.chng_in_oi > 0 ? '+' : ''}${alert.chng_in_oi.toLocaleString()} lots | 
                            Gap: ${alert.diff_vs_chng.toLocaleString()} lots
                        </div>
                    `;
                } else {
                    // Regular OI change alerts (left table)
                    detailsHtml = `
                        <div class="alert-details">
                            Previous: ${alert.prev_oi_lots.toLocaleString()} lots ‚Üí Live: ${alert.live_oi_lots.toLocaleString()} lots (Change: ${alert.oi_change_lots > 0 ? '+' : ''}${alert.oi_change_lots.toLocaleString()} lots)
                        </div>
                    `;
                }
                
                alertDiv.innerHTML = `
                    <div class="alert-time">‚è∞ ${timestamp}</div>
                    <div class="alert-message">üö® ${alert.symbol} - ${alert.alert_message}</div>
                    ${detailsHtml}
                `;
                alertsList.appendChild(alertDiv);
            });
            
            alertsSection.style.display = 'block';
            document.getElementById('alertCount').textContent = currentCycleAlerts.length;
        }
        
        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            currentCycleAlerts = []; // Reset alerts for new monitoring session
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            updateStatus('Starting...', true);
            
            // Start first cycle immediately (recursive setTimeout will handle subsequent cycles)
            loadTableData();
        }
        
        function stopMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            
            // Clear the timeout if any is scheduled
            if (monitoringInterval) {
                clearTimeout(monitoringInterval);
                monitoringInterval = null;
            }
            
            // Update UI immediately
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            showLoading(false);
            updateStatus('Stopped');
            
            console.log('Monitoring stopped - no new requests will be made');
        }
        
        async function storeLiveEodOi() {
            if (!confirm('This will store LIVE OI totals at current spot price (spot ¬±10) for all stocks.\n\nThis data will be used as "Previous Day EOD OI" tomorrow.\n\nClick at 3:30 PM today to capture the data.\n\nContinue?')) {
                return;
            }
            
            const storeBtn = document.getElementById('storeEodBtn');
            storeBtn.disabled = true;
            storeBtn.textContent = '‚è≥ Storing...';
            showLoading(true);
            updateStatus('Storing Live EOD OI...', true);
            
            try {
                const response = await fetch('/api/store-live-eod-oi', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Live EOD OI data stored successfully!\n\nProcessed: ${data.processed_count} stocks\nFailed: ${data.failed_count} stocks\n\nDate: ${data.date}\n\nThis data will be used as "Previous Day EOD OI" tomorrow.`);
                    updateStatus('EOD OI Stored');
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                    updateStatus('Error');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                updateStatus('Error');
            } finally {
                storeBtn.disabled = false;
                storeBtn.textContent = 'üíæ Store Live EOD OI (3:30PM)';
                showLoading(false);
            }
        }
    </script>
</body>
</html>
