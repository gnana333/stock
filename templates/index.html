<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Monitor - Call/Put Alerts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .page-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .main-column {
            flex: 1.2;
            min-width: 600px;
        }

        .side-column {
            flex: 1;
            min-width: 500px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 12px 25px;
            font-size: 15px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-alerts {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-alerts:hover {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        .btn-refresh {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .status-value.live {
            color: #11998e;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }


        .ratio-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .ratio-normal {
            background: #d4edda;
            color: #155724;
        }

        .ratio-warning {
            background: #fff3cd;
            color: #856404;
        }

        .ratio-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .alerts-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .alerts-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .alert-item {
            background: white;
            padding: 15px;
            border-left: 4px solid #ff6b6b;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-item.call-alert {
            border-left-color: #ff6b6b;
        }

        .alert-item.put-alert {
            border-left-color: #ee5a6f;
        }

        .alert-item.call-volume-drop-alert {
            border-left-color: #3498db;
            background-color: #eaf2f8;
        }

        .alert-item.put-volume-drop-alert {
            border-left-color: #9b59b6;
            background-color: #f5eef8;
        }

        .alert-time {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .alert-message {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .alert-details {
            font-size: 0.9em;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .volume-drops-table {
            width: 100%;
            margin-top: 0;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .volume-drops-table th {
            background: linear-gradient(to bottom, #6c7ae0, #546de5);
            color: white;
            padding: 12px 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
        }

        .volume-drops-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .volume-drops-table tr:hover {
            background-color: rgba(108, 122, 224, 0.1);
        }

        .volume-drops-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .volume-drop-row-call {
            background-color: rgba(52, 152, 219, 0.15);
        }

        .volume-drop-row-put {
            background-color: rgba(155, 89, 182, 0.15);
        }

        .volume-drop-row-call td:nth-child(2),
        .volume-drop-row-call td:nth-child(3) {
            font-weight: bold;
            color: #2980b9;
        }

        .volume-drop-row-put td:nth-child(4),
        .volume-drop-row-put td:nth-child(5) {
            font-weight: bold;
            color: #8e44ad;
        }

        .table-container,
        .volume-drops-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        .table-header,
        .volume-drops-header {
            background: linear-gradient(135deg, #6c7ae0, #546de5);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-button {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background-color: #0b7dda;
            transform: translateY(-2px);
        }

        /* Floating Jump to Alerts Button (Circle on Right Side) */
        .floating-alerts-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }

        .floating-alerts-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
        }

        .floating-alerts-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä Volume Monitor</h1>
        <p class="subtitle">Call vs Call & Put vs Put Comparison</p>

        <div class="controls">
            <button id="refreshBtn" onclick="refreshData()" class="btn-refresh">üîÑ Refresh Previous Day Data</button>
            <button id="startBtn" onclick="startMonitoring()" class="btn-start">‚ñ∂Ô∏è Start Live Monitoring</button>
            <button id="stopBtn" onclick="stopMonitoring()" class="btn-stop" style="display: none;">‚è∏Ô∏è Stop
                Monitoring</button>
            <button onclick="window.location.href='/oi-monitor'" class="btn-alerts">üìä OI Monitor</button>
            <button onclick="window.location.href='/oi-change-alerts'" class="btn-alerts">üìâ OI Strike Alerts</button>
            <button onclick="window.location.href='/options'" class="btn-alerts">‚ö° Options Chain</button>
            <button onclick="window.location.href='/historical'" class="btn-alerts">üìÖ Historical Data</button>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Total Stocks</div>
                <div class="status-value" id="totalStocks">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Status</div>
                <div class="status-value" id="monitorStatus">Idle</div>
            </div>
            <div class="status-item">
                <div class="status-label">Last Update</div>
                <div class="status-value" id="lastUpdate">-</div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p id="loadingMessage">Loading data... Please wait</p>
            <p id="loadingSubtext" style="font-size: 0.9em; color: #888; margin-top: 10px;"></p>
        </div>

        <div class="page-layout">
            <div class="main-column">
                <div class="table-header">
                    <span>üìä Volume Monitor Table</span>
                    <span id="mainTableCount">0 stocks</span>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Prev Call Lots</th>
                                <th>Live Call Lots</th>
                                <th>Call Ratio</th>
                                <th>Prev Put Lots</th>
                                <th>Live Put Lots</th>
                                <th>Put Ratio</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="7" class="no-data">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="side-column">
                <div class="table-header">
                    <h3>Volume Drops Table (21 Strikes - Spot ¬±10) <span id="volumeDropsCount">0 stocks</span></h3>
                    <div class="timestamp-info" id="volumeDropsTimestampInfo"></div>
                </div>
                <div class="volume-drops-container">
                    <table class="volume-drops-table">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Prev CE Lots</th>
                                <th>Live CE Lots</th>
                                <th>Prev PE Lots</th>
                                <th>Live PE Lots</th>
                                <th>Prev Cycle Time</th>
                            </tr>
                        </thead>
                        <tbody id="volumeDropsTableBody">
                            <tr>
                                <td colspan="6" class="no-data">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Floating Jump to Alerts Button (Right Side) -->
        <button id="floatingAlertsBtn" class="floating-alerts-btn" onclick="scrollToAlerts()" title="Jump to Alerts">
            üì¢
        </button>

        <!-- Today's Alerts Display Section (Moved to Bottom) -->
        <div id="alertsDisplaySection" style="display: none; margin: 40px 0 20px 0;">
            <div
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.1em;">üì¢ Today's Alerts</h3>
                <span id="totalAlertsCount"
                    style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">0
                    alerts</span>
            </div>
            <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <!-- Volume Alerts (2x Previous Day) -->
                <div>
                    <h4 style="margin: 0 0 15px 0; color: #667eea; display: flex; align-items: center; gap: 8px;">
                        <span>üìà Volume Alerts (2x Previous Day)</span>
                        <span id="volumeAlertsCount"
                            style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">0</span>
                    </h4>
                    <div id="volumeAlertsContainer"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                        <p style="text-align: center; color: #999; padding: 20px;">No volume alerts yet</p>
                    </div>
                </div>

                <!-- Volume Drop Alerts (Cycle-to-Cycle) -->
                <div>
                    <h4 style="margin: 0 0 15px 0; color: #ee5a6f; display: flex; align-items: center; gap: 8px;">
                        <span>üìâ Volume Drop Alerts (Cycle Drops ‚â•100 lots)</span>
                        <span id="volumeDropAlertsCount"
                            style="background: #fce4ec; color: #c2185b; padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">0</span>
                    </h4>
                    <div id="volumeDropAlertsContainer"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                        <p style="text-align: center; color: #999; padding: 20px;">No volume drop alerts yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let monitoringInterval = null;
        window.latestTableData = [];
        window.previousCycleData = {};

        function showLoading(show, message = 'Loading data... Please wait', subtext = '') {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('loadingMessage').textContent = message;
                document.getElementById('loadingSubtext').textContent = subtext;
            }
        }

        function updateStatus(status, isLive = false) {
            const statusEl = document.getElementById('monitorStatus');
            statusEl.textContent = status;
            if (isLive) {
                statusEl.classList.add('live');
            } else {
                statusEl.classList.remove('live');
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        function scrollToAlerts() {
            const alertsSection = document.getElementById('alertsDisplaySection');
            if (alertsSection && alertsSection.style.display !== 'none') {
                alertsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                alert('No alerts to display yet. Start monitoring to generate alerts!');
            }
        }

        function updateFloatingButton() {
            const alertsSection = document.getElementById('alertsDisplaySection');
            const floatingBtn = document.getElementById('floatingAlertsBtn');

            if (alertsSection && alertsSection.style.display !== 'none') {
                floatingBtn.style.display = 'block';
            } else {
                floatingBtn.style.display = 'none';
            }
        }

        async function refreshData() {
            if (!confirm('This will delete all existing data and fetch fresh previous day data. Continue?')) {
                return;
            }

            showLoading(true);
            updateStatus('Refreshing...');

            try {
                const response = await fetch('/api/refresh-previous-day-data', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Data refreshed successfully!\nProcessed: ${data.processed_count}\nFailed: ${data.failed_count}`);
                    updateStatus('Ready');
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                    updateStatus('Error');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                updateStatus('Error');
            } finally {
                showLoading(false);
            }
        }

        async function loadTableData() {
            // Don't start new request if monitoring is stopped
            if (!isMonitoring) {
                console.log('Monitoring stopped, skipping request');
                return;
            }

            try {
                console.log('Fetching table data...');
                updateStatus('Loading data...', true);

                // Add timeout to fetch request (20 minutes for all stocks - very safe)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 minute timeout

                const response = await fetch('/api/get-table-data', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                console.log('‚úÖ API Response received successfully');
                console.log('üìä Response contains:', {
                    totalStocks: data.total_stocks,
                    tableDataCount: data.table_data ? data.table_data.length : 0,
                    previousCycleDataCount: data.previous_cycle_data ? Object.keys(data.previous_cycle_data).length : 0,
                    newAlertsCount: data.new_alerts ? data.new_alerts.length : 0,
                    callDropAlertsCount: data.call_volume_drop_alerts ? data.call_volume_drop_alerts.length : 0,
                    putDropAlertsCount: data.put_volume_drop_alerts ? data.put_volume_drop_alerts.length : 0
                });

                if (!data.success) {
                    console.error('API returned error:', data.error);
                    alert(`Error: ${data.error}`);
                    return;
                }

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                if (!data.table_data || data.table_data.length === 0) {
                    console.log('No table data available');
                    tbody.innerHTML = '<tr><td colspan="8" class="no-data">No data available</td></tr>';
                    return;
                }

                // Store the latest table data globally for use in the volume drops table
                window.latestTableData = data.table_data;

                // Store previous cycle data
                window.previousCycleData = data.previous_cycle_data || {};
                console.log('Previous cycle data:', window.previousCycleData);

                console.log(`Processing ${data.table_data.length} rows`);

                // Store new alerts from this cycle

                data.table_data.forEach((row, index) => {
                    try {
                        const tr = document.createElement('tr');
                        if (row.call_alert || row.put_alert) {
                            tr.classList.add('alert-row');
                        }

                        let callRatioClass = 'ratio-normal';
                        if (row.call_ratio >= 2.0) {
                            callRatioClass = 'ratio-danger';
                        } else if (row.call_ratio >= 1.5) {
                            callRatioClass = 'ratio-warning';
                        }

                        let putRatioClass = 'ratio-normal';
                        if (row.put_ratio >= 2.0) {
                            putRatioClass = 'ratio-danger';
                        } else if (row.put_ratio >= 1.5) {
                            putRatioClass = 'ratio-warning';
                        }

                        tr.innerHTML = `
                            <td><strong>${row.symbol || 'N/A'}</strong></td>
                            <td>${(row.prev_call_lots || 0).toLocaleString()}</td>
                            <td>${(row.live_call_lots || 0).toLocaleString()}</td>
                            <td><span class="ratio-badge ${callRatioClass}">${(row.call_ratio || 0).toFixed(2)}x</span></td>
                            <td>${(row.prev_put_lots || 0).toLocaleString()}</td>
                            <td>${(row.live_put_lots || 0).toLocaleString()}</td>
                            <td><span class="ratio-badge ${putRatioClass}">${(row.put_ratio || 0).toFixed(2)}x</span></td>
                        `;

                        tbody.appendChild(tr);
                    } catch (rowError) {
                        console.error(`Error processing row ${index}:`, rowError, row);
                    }
                });

                // Update total stocks count
                document.getElementById('totalStocks').textContent = data.total_stocks || '0';
                document.getElementById('mainTableCount').textContent = `${data.total_stocks || 0} stocks`;

                // NOW update the volume drops table AFTER all data is processed
                console.log('‚úÖ Main table updated, now updating volume drops table...');
                console.log('üìä Previous cycle data available:', Object.keys(window.previousCycleData || {}).length, 'stocks');
                console.log('üìä Latest table data count:', window.latestTableData ? window.latestTableData.length : 0);

                // Show sample of previous cycle data for debugging
                const sampleSymbols = ['ABB', 'RELIANCE', 'TCS'];
                sampleSymbols.forEach(symbol => {
                    if (window.previousCycleData[symbol]) {
                        console.log(`üìä Previous cycle ${symbol}:`, window.previousCycleData[symbol]);
                    }
                });

                updateVolumeDropsTable();
                console.log('‚úÖ Volume drops table updated');

                updateLastUpdate();
                updateStatus('Live', true);
                console.log('‚úÖ Full cycle update completed successfully');

                // Load and display today's alerts after data update
                console.log('üîÑ Loading today\'s alerts after cycle completion...');
                await loadTodaysAlerts();
                console.log('‚úÖ Alerts loading completed');

            } catch (error) {
                console.error('Error loading table data:', error);
                if (error.name === 'AbortError') {
                    console.log('Frontend timeout occurred after 20 minutes');
                    // Check if the backend is still processing by looking at logs
                    alert('‚è±Ô∏è Request took longer than 20 minutes.\n\n' +
                        '‚úÖ Check your backend console/logs - it might still be processing.\n' +
                        'üìä Look for "Progress: X/150 stocks processed" messages.\n' +
                        '‚è∞ Wait for "MONITORING CYCLE COMPLETED" message.\n\n' +
                        'If processing is done, click Start again to fetch results.');
                    updateStatus('Timeout - Check Backend Logs');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    alert('‚ùå Network connection lost or server stopped responding.\n\n' +
                        'Check:\n' +
                        '1. Is your Flask server still running?\n' +
                        '2. Check backend logs for errors\n' +
                        '3. Try refreshing the page and starting again');
                    updateStatus('Connection Error');
                } else {
                    alert(`‚ùå Error loading data: ${error.message}\n\nCheck backend logs for details.`);
                    updateStatus('Error');
                }
                // Show error in table
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">‚ùå Error loading data. Check console and backend logs.</td></tr>';
            }
        }

        function updateVolumeDropsTable() {
            console.log('üîÑ updateVolumeDropsTable() called');
            console.log('üìä window.latestTableData length:', window.latestTableData ? window.latestTableData.length : 0);
            console.log('üìä window.previousCycleData keys:', Object.keys(window.previousCycleData || {}).length);

            const tableBody = document.getElementById('volumeDropsTableBody');
            const allStocks = new Map(); // Map to store stock data: symbol -> {prevCall, liveCall, prevPut, livePut}

            // First, get all stocks from the main table data
            if (window.latestTableData && window.latestTableData.length > 0) {
                console.log('‚úÖ Processing', window.latestTableData.length, 'stocks for volume drops table');
                window.latestTableData.forEach(row => {
                    // Get previous cycle data for this stock from the backend
                    const prevCycleData = window.previousCycleData[row.symbol] || {};

                    // RIGHT TABLE LOGIC (21-strike volumes ONLY):
                    // Live CE = Current cycle's 21-strike CE volume (what we just got from API)
                    // Prev CE = Previous cycle's 21-strike CE volume (what was stored in DB from last cycle)
                    // Diff CE = Prev CE - Live CE (if Diff > 100, ALERT)

                    // PREV values: From previous cycle (stored in DB)
                    const prevCallLots = Number(prevCycleData.call_lots_21 || 0);
                    const prevPutLots = Number(prevCycleData.put_lots_21 || 0);

                    // LIVE values: From current cycle (just fetched from API)
                    const liveCallLots = Number(row.live_call_lots_21 || 0);  // 21 strikes only
                    const livePutLots = Number(row.live_put_lots_21 || 0);    // 21 strikes only

                    // DIFF = PREV - LIVE (positive = volume dropped, negative = volume increased)
                    const diffCall = prevCallLots - liveCallLots;
                    const diffPut = prevPutLots - livePutLots;

                    // ALERT if DIFF > 100 (means volume dropped by more than 100 lots)
                    const callDrop = prevCallLots > 0 && diffCall >= 100;
                    const putDrop = prevPutLots > 0 && diffPut >= 100;

                    // Debug logging for verification
                    if (row.symbol === 'ABB' || row.symbol === 'RELIANCE' || row.symbol === 'TCS') {
                        console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
                        console.log(`RIGHT TABLE [${row.symbol}] - 21 Strikes (Spot ¬±10):`);
                        console.log(`  üìä CE: Prev=${prevCallLots}, Live=${liveCallLots}, Diff=${diffCall}`);
                        console.log(`  üìä PE: Prev=${prevPutLots}, Live=${livePutLots}, Diff=${diffPut}`);
                        console.log(`  üö® Alerts: CE=${callDrop ? 'YES' : 'NO'}, PE=${putDrop ? 'YES' : 'NO'}`);
                        console.log(`  ‚è∞ Prev Timestamp: ${prevCycleData.timestamp || 'N/A'}`);
                        console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
                    }

                    allStocks.set(row.symbol, {
                        symbol: row.symbol,
                        prevCall: prevCallLots,      // Previous cycle's 21-strike CE
                        liveCall: liveCallLots,      // Current cycle's 21-strike CE
                        prevPut: prevPutLots,        // Previous cycle's 21-strike PE
                        livePut: livePutLots,        // Current cycle's 21-strike PE
                        callChange: diffCall,        // Diff = Prev - Live
                        putChange: diffPut,          // Diff = Prev - Live
                        prevTimestamp: prevCycleData.timestamp || '',
                        hasCallDrop: callDrop,       // Alert if Diff >= 100
                        hasPutDrop: putDrop          // Alert if Diff >= 100
                    });
                });
            }

            // Clear the table
            tableBody.innerHTML = '';

            // If no stocks, show "No data" message
            if (allStocks.size === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
                document.getElementById('volumeDropsCount').textContent = '0 stocks';
                return;
            }

            // Convert map to array and sort by symbol
            const stocksArray = Array.from(allStocks.values()).sort((a, b) => a.symbol.localeCompare(b.symbol));

            // Count stocks with drops (only show these with alerts)
            const stocksWithDrops = stocksArray.filter(stock => stock.hasCallDrop || stock.hasPutDrop).length;

            // Add rows to the table
            stocksArray.forEach(stock => {
                const row = document.createElement('tr');

                // Add appropriate class based on which type of drop occurred
                if (stock.hasCallDrop && stock.hasPutDrop) {
                    row.className = 'volume-drop-row-call volume-drop-row-put';
                } else if (stock.hasCallDrop) {
                    row.className = 'volume-drop-row-call';
                } else if (stock.hasPutDrop) {
                    row.className = 'volume-drop-row-put';
                }

                // Display alert badges only when volume dropped by >= 100 lots
                let ceAlert = '';
                let peAlert = '';

                // Alert badge shows the drop amount (Diff = Prev - Live)
                if (stock.hasCallDrop) {
                    ceAlert = `<span style="background:#ff6b6b;color:white;padding:2px 6px;border-radius:3px;font-size:0.8em;margin-left:5px;">Alert ‚ñº${stock.callChange.toLocaleString()}</span>`;
                }

                if (stock.hasPutDrop) {
                    peAlert = `<span style="background:#ee5a6f;color:white;padding:2px 6px;border-radius:3px;font-size:0.8em;margin-left:5px;">Alert ‚ñº${stock.putChange.toLocaleString()}</span>`;
                }

                row.innerHTML = `
                    <td><strong>${stock.symbol}</strong></td>
                    <td>${stock.prevCall.toLocaleString()}</td>
                    <td>${stock.liveCall.toLocaleString()} ${ceAlert}</td>
                    <td>${stock.prevPut.toLocaleString()}</td>
                    <td>${stock.livePut.toLocaleString()} ${peAlert}</td>
                    <td>${stock.prevTimestamp || '-'}</td>
                `;

                tableBody.appendChild(row);
            });

            // Update the count - show total stocks and how many have alerts
            document.getElementById('volumeDropsCount').textContent = `${allStocks.size} stocks${stocksWithDrops > 0 ? ` (${stocksWithDrops} alerts)` : ''}`;

            // Update the timestamp info for the previous cycle data
            // Find the most recent timestamp from the data
            let mostRecentTimestamp = '';
            allStocks.forEach(stock => {
                if (stock.prevTimestamp && (!mostRecentTimestamp || stock.prevTimestamp > mostRecentTimestamp)) {
                    mostRecentTimestamp = stock.prevTimestamp;
                }
            });

            if (mostRecentTimestamp) {
                document.getElementById('volumeDropsTimestampInfo').textContent = `Previous Cycle: ${mostRecentTimestamp}`;
            } else {
                document.getElementById('volumeDropsTimestampInfo').textContent = '';
            }

            console.log('‚úÖ updateVolumeDropsTable() completed:', {
                totalStocks: allStocks.size,
                stocksWithDrops: stocksWithDrops,
                mostRecentTimestamp: mostRecentTimestamp
            });

            // Sample display to verify data flow
            if (allStocks.size > 0) {
                const sampleStocks = Array.from(allStocks.values()).slice(0, 3);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üìä RIGHT TABLE DISPLAY VERIFICATION (21-Strike Volumes):');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                sampleStocks.forEach(stock => {
                    console.log(`${stock.symbol}:`);
                    console.log(`  Prev CE: ${stock.prevCall} lots | Live CE: ${stock.liveCall} lots | Diff: ${stock.callChange} lots | Alert: ${stock.hasCallDrop ? 'YES' : 'NO'}`);
                    console.log(`  Prev PE: ${stock.prevPut} lots | Live PE: ${stock.livePut} lots | Diff: ${stock.putChange} lots | Alert: ${stock.hasPutDrop ? 'YES' : 'NO'}`);
                });
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            }
        }

        async function loadTodaysAlerts() {
            try {
                console.log('üì¢ Fetching today\'s alerts...');
                const response = await fetch('/api/get-todays-alerts');

                if (!response.ok) {
                    console.error(`‚ùå Failed to fetch alerts: ${response.status} ${response.statusText}`);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    const volumeAlerts = data.volume_alerts || [];
                    const volumeDropAlerts = data.volume_drop_alerts || [];
                    const totalAlerts = volumeAlerts.length + volumeDropAlerts.length;

                    console.log(`‚úÖ Loaded ${volumeAlerts.length} volume alerts and ${volumeDropAlerts.length} volume drop alerts`);
                    console.log('üìä Volume Alerts:', volumeAlerts);
                    console.log('üìä Volume Drop Alerts:', volumeDropAlerts);

                    // Show/hide alerts section
                    const alertsSection = document.getElementById('alertsDisplaySection');
                    if (totalAlerts > 0) {
                        console.log('‚úÖ Displaying alerts section (total alerts:', totalAlerts, ')');
                        alertsSection.style.display = 'block';
                        updateFloatingButton();  // Show/hide floating button
                    } else {
                        console.log('‚ö†Ô∏è No alerts to display');
                        alertsSection.style.display = 'none';
                        updateFloatingButton();  // Show/hide floating button
                        return; // No alerts to display
                    }

                    // Update counts
                    document.getElementById('totalAlertsCount').textContent = `${totalAlerts} alert${totalAlerts !== 1 ? 's' : ''}`;
                    document.getElementById('volumeAlertsCount').textContent = volumeAlerts.length;
                    document.getElementById('volumeDropAlertsCount').textContent = volumeDropAlerts.length;

                    // Display Volume Alerts (2x Previous Day)
                    const volumeAlertsContainer = document.getElementById('volumeAlertsContainer');
                    console.log('üìä Rendering volume alerts container...');
                    if (volumeAlerts.length > 0) {
                        console.log(`‚úÖ Rendering ${volumeAlerts.length} volume alerts`);
                        volumeAlertsContainer.innerHTML = volumeAlerts.map(alert => {
                            const bgColor = alert.alert_type === 'CALL' ? '#fff3cd' : '#f8d7da';
                            const borderColor = alert.alert_type === 'CALL' ? '#ffc107' : '#dc3545';
                            const icon = alert.alert_type === 'CALL' ? 'üìû' : 'üìù';
                            return `
                                <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 12px; margin-bottom: 10px; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <strong style="font-size: 1.05em;">${icon} ${alert.symbol}</strong>
                                        <span style="color: #666; font-size: 0.9em;">‚è∞ ${alert.formatted_time}</span>
                                    </div>
                                    <div style="font-size: 0.95em; color: #333; margin: 5px 0;">
                                        ${alert.alert_message}
                                    </div>
                                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                        Prev: ${alert.prev_lots} lots ‚Üí Live: ${alert.live_lots} lots (${alert.ratio}x)
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        volumeAlertsContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No volume alerts yet</p>';
                    }

                    // Display Volume Drop Alerts (Cycle-to-Cycle)
                    const volumeDropAlertsContainer = document.getElementById('volumeDropAlertsContainer');
                    console.log('üìä Rendering volume drop alerts container...');
                    if (volumeDropAlerts.length > 0) {
                        console.log(`‚úÖ Rendering ${volumeDropAlerts.length} volume drop alerts`);
                        volumeDropAlertsContainer.innerHTML = volumeDropAlerts.map(alert => {
                            const bgColor = alert.option_type === 'CALL' ? '#ffe6e6' : '#ffe0f0';
                            const borderColor = alert.option_type === 'CALL' ? '#ff6b6b' : '#ee5a6f';
                            const icon = alert.option_type === 'CALL' ? 'üìâ' : 'üìä';
                            return `
                                <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 12px; margin-bottom: 10px; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <strong style="font-size: 1.05em;">${icon} ${alert.symbol}</strong>
                                        <span style="color: #666; font-size: 0.9em;">‚è∞ ${alert.formatted_time}</span>
                                    </div>
                                    <div style="font-size: 0.95em; color: #333; margin: 5px 0;">
                                        ${alert.alert_message}
                                    </div>
                                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                        Prev: ${alert.prev_lots} lots ‚Üí Current: ${alert.current_lots} lots (‚ñº${Math.abs(alert.volume_change)} lots)
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        volumeDropAlertsContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No volume drop alerts yet</p>';
                    }
                } else {
                    console.error('‚ùå API returned error:', data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('‚ùå Error loading today\'s alerts:', error);
                console.error('Error details:', error.message);
            }
        }

        async function startMonitoring() {
            alert('DEBUG: Start Monitoring clicked');
            console.log('DEBUG: Start Monitoring clicked');
            if (isMonitoring) return;

            isMonitoring = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            updateStatus('Processing...', true);

            // Show loading overlay with detailed message
            showLoading(true, 'Processing all stocks...', 'This may take 2-5 minutes for 150+ stocks (OPTIMIZED). Check backend console for progress updates. Please be patient...');

            // Show loading message in table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="no-data">‚è≥ Processing 150+ stocks... Please wait (2-5 minutes OPTIMIZED)<br><br>üí° TIP: Watch your backend console for real-time progress updates</td></tr>';

            // Show loading message in volume drops table
            const volumeDropsTableBody = document.getElementById('volumeDropsTableBody');
            volumeDropsTableBody.innerHTML = '<tr><td colspan="6" class="no-data">‚è≥ Processing volume drops... Please wait</td></tr>';

            // Add a timer to show elapsed time
            let startTime = Date.now();
            let timerInterval = setInterval(() => {
                if (!isMonitoring) {
                    clearInterval(timerInterval);
                    return;
                }
                let elapsed = Math.floor((Date.now() - startTime) / 1000);
                let minutes = Math.floor(elapsed / 60);
                let seconds = elapsed % 60;
                updateStatus(`Processing... (${minutes}m ${seconds}s)`, true);
            }, 1000);

            // Load data immediately
            try {
                await loadTableData();
                clearInterval(timerInterval);
            } catch (error) {
                clearInterval(timerInterval);
                throw error;
            }

            // Hide loading overlay after data loads
            showLoading(false);

            // Then set up interval for periodic updates (every 30 seconds)
            // This will fetch new data and update BOTH tables
            monitoringInterval = setInterval(async () => {
                console.log('‚è∞ Starting automatic cycle update (30s interval)...');
                await loadTableData();
                console.log('‚è∞ Automatic cycle update completed');
            }, 30000);
        }

        function stopMonitoring() {
            if (!isMonitoring) return;

            isMonitoring = false;
            clearInterval(monitoringInterval);
            monitoringInterval = null;

            // Update UI immediately
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            updateStatus('Stopped');


            // Clear volume drops table
            document.getElementById('volumeDropsTableBody').innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
            document.getElementById('volumeDropsCount').textContent = '0 stocks';
            document.getElementById('mainTableCount').textContent = '0 stocks';

            // Clear latest table data
            window.latestTableData = [];
            window.previousCycleData = {};

            console.log('Monitoring stopped - no new requests will be made');
        }


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateStatus('Ready');

            // Load today's alerts on page load
            loadTodaysAlerts();

            // Auto-refresh alerts every 30 seconds (even when not monitoring)
            setInterval(loadTodaysAlerts, 30000);
        });

    </script>
</body>

</html>